name: "Verify MCP Usage"
description: "Verifies that both CloudWatch and Application Signals MCP tools were called"

inputs:
  artifact_name:
    description: "Name of the artifact containing test outputs"
    required: true
  output_path:
    description: "Path to download test outputs"
    required: false
    default: "./test-outputs"

runs:
  using: "composite"
  steps:
    - name: Download test outputs
      uses: actions/download-artifact@v4
      with:
        name: ${{ inputs.artifact_name }}
        path: ${{ inputs.output_path }}

    - name: Verify MCP tool usage
      shell: bash
      run: |
        echo "Checking for MCP tool usage..."
        
        EXECUTION_FILE="${{ inputs.output_path }}/claude-execution-output.json"
        
        if [[ ! -f "$EXECUTION_FILE" ]]; then
          echo "ERROR: Execution file not found at $EXECUTION_FILE"
          echo "Available files:"
          find "${{ inputs.output_path }}" -type f | head -10
          exit 1
        fi
        
        echo "Found execution file, checking for tool_use calls..."
        
        # Check for Application Signals MCP tool_use
        if jq -e '.[] | select(.type == "assistant") | .message.content[]? | select(.type == "tool_use" and .name == "mcp__applicationsignals__list_monitored_services")' "$EXECUTION_FILE" > /dev/null; then
          echo "âœ… PASSED - list_monitored_services tool call found"
        else
          echo "âŒ FAILED: list_monitored_services tool call not found"
          exit 1
        fi
        
        # Check for CloudWatch MCP tool_use
        if jq -e '.[] | select(.type == "assistant") | .message.content[]? | select(.type == "tool_use" and .name == "mcp__awslabs_cloudwatch-mcp-server__get_active_alarms")' "$EXECUTION_FILE" > /dev/null; then
          echo "âœ… PASSED - get_active_alarms tool call found"
        else
          echo "âŒ FAILED: get_active_alarms tool call not found"
          exit 1
        fi
        
        echo "ğŸ‰ All MCP tool usage verification checks passed!"